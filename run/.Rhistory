rm(list = ls())
path_fun <- '../ABM_functions/'
ff <- list.files(path = path_fun)
ff <- ff[ff != 'x.R']
for (i in ff) source(paste0(path_fun,i))
library('readxl')
library('lubridate')
library('dplyr')
library('tidyr')
library('openxlsx')
meas_C <- as.data.frame(read_excel("../data/dat_simple.xlsx", sheet = "C"))
meas_FF <- as.data.frame(read_excel("../data/dat_simple.xlsx", sheet = "FF"))
meas_SF <- as.data.frame(read_excel("../data/dat_simple.xlsx", sheet = "SF"))
meas_ST <- as.data.frame(read_excel("../data/dat_simple.xlsx", sheet = "ST"))
opt_pars <- as.data.frame(read_excel('../data/opt_pars.xlsx'))
dat_temp <- read.csv('../data/dat_temp.csv')
meas_C$time <- meas_C$days
meas_C$slurry_mass <- meas_C$mass
slurry_mass_dat_C <- meas_C[!is.na(meas_C$mass), c('date', 'time', 'slurry_mass')]
wash_dates_C <-ymd_hms(c("2020-08-13 07:00:00 UTC", "2020-11-05 02:00:00 UTC", "2021-01-28 02:00:00 UTC"))
slurry_mass_dat_C$wash_water <- 0
slurry_mass_dat_C$wash_water[slurry_mass_dat_C$date %in% wash_dates_C] <- 3500
slurry_mass_dat_C$date <- NULL
slurry_mass_dat_C <- slurry_mass_dat_C[!duplicated(slurry_mass_dat_C),]
temp_dat_C <- meas_C[!is.na(meas_C$temp), c('time', 'temp')]
temp_dat_C <- data.frame(data.table::data.table(temp_dat_C)[, .(time = mean(time), temp = mean(temp)), by = .(timebin = floor(time / 1))])[,-c(1)]
meas_FF$time <- meas_FF$days
meas_FF$slurry_mass <- meas_FF$mass
slurry_mass_dat_FF <- meas_FF[!is.na(meas_FF$mass), c('date', 'time', 'slurry_mass')]
wash_dates_FF <-ymd_hms(c("2020-08-13 05:00:00 UTC", "2020-11-05 04:00:00 UTC", "2021-01-28 04:00:00 UTC"))
slurry_mass_dat_FF$wash_water <- 0
slurry_mass_dat_FF$wash_water[slurry_mass_dat_FF$date %in% wash_dates_FF] <- 3500
slurry_mass_dat_FF$date <- NULL
slurry_mass_dat_FF <- slurry_mass_dat_FF[!duplicated(slurry_mass_dat_FF),]
temp_dat_FF <- meas_FF[!is.na(meas_FF$temp), c('time', 'temp')]
temp_dat_FF <- data.frame(data.table::data.table(temp_dat_FF)[, .(time = mean(time), temp = mean(temp)), by = .(timebin = floor(time / 1))])[,-c(1)]
meas_SF$time <- meas_SF$days
meas_SF$slurry_mass <- meas_SF$mass
slurry_mass_dat_SF <- meas_SF[!is.na(meas_SF$mass), c('date', 'time', 'slurry_mass')]
wash_dates_SF <-ymd_hms(c("2020-08-13 07:00:00 UTC", "2020-11-04 07:00:00 UTC", "2021-01-27 07:00:00 UTC"))
slurry_mass_dat_SF$wash_water <- 0
slurry_mass_dat_SF$wash_water[slurry_mass_dat_SF$date %in% wash_dates_SF] <- 3500
slurry_mass_dat_SF$date <- NULL
slurry_mass_dat_SF <- slurry_mass_dat_SF[!duplicated(slurry_mass_dat_SF),]
temp_dat_SF <- meas_FF[!is.na(meas_FF$temp), c('time', 'temp')]
temp_dat_SF <- data.frame(data.table::data.table(temp_dat_SF)[, .(time = mean(time), temp = mean(temp)), by = .(timebin = floor(time / 1))])[,-c(1)]
meas_ST$time <- meas_ST$days
meas_ST$slurry_mass <- meas_ST$mass
slurry_mass_dat_ST <- meas_ST[!is.na(meas_ST$mass), c('date', 'time', 'slurry_mass')]
wash_dates_ST <-ymd_hms(c("2020-08-13 02:00:00 UTC", "2020-11-05 02:00:00 UTC", "2021-01-28 02:00:00 UTC"))
slurry_mass_dat_ST$wash_water <- 0
slurry_mass_dat_ST$wash_water[slurry_mass_dat_ST$date %in% wash_dates_ST] <- 3500
slurry_mass_dat_ST$date <- NULL
slurry_mass_dat_ST <- slurry_mass_dat_ST[!duplicated(slurry_mass_dat_ST),]
temp_dat_ST <- meas_FF[!is.na(meas_FF$temp), c('time', 'temp')]
temp_dat_ST <- data.frame(data.table::data.table(temp_dat_ST)[, .(time = mean(time), temp = mean(temp)), by = .(timebin = floor(time / 1))])[,-c(1)]
wthr_pars = list(temp_air_C = 20, RH = 90, rain = 0, pres_kpa = 101, rs = 10)
evap_pars = list(evap = 0.5 * et(temp_C = wthr_pars$temp_air_C, pres_kpa = wthr_pars$pres_kpa, rs = wthr_pars$rs))
grz_pars = list(graze_start = "May",
graze_days = 0,
graze_hours = 0)
grp_pars = list(grps = c('m0','m1','m2', 'sr1'),
yield = c(default = 0.05, sr1 = 0.065),
xa_fresh = c(default = 0.02),
xa_init = c(all = 0.0001),
decay_rate = c(all = 0.02),
ks_coefficient = c(default = 1, sr1 = 0.4),
qhat_opt = c(m0 = 1.5, m1 = 3.6, m2 = 5.6 , m3 = 7.2, m4 = 8, m5 = 8, sr1 = 8),
T_opt = c(m0 = 18, m1 = 18, m2 = 28, m3 = 36, m4 = 43.75, m5 = 55, sr1 = 43.75),
T_min = c(m0 = 0, m1 = 10, m2 = 10, m3 = 15, m4 = 26.25, m5 = 30, sr1 = 0),
T_max = c(m0 = 25, m1 = 25, m2 = 38, m3 = 45, m4 = 51.25, m5 = 60, sr1 = 51.25),
ki_NH3_min = c(all = 0.015),
ki_NH3_max = c(all = 0.13),
ki_NH4_min = c(all = 2.7),
ki_NH4_max = c(all = 4.8),
pH_upr = c(all = 8.0),
pH_lwr = c(default = 6.0))
mic_pars = list(ks_SO4 = 0.0067,
ki_H2S_meth = 0.23,
ki_H2S_sr = 0.25,
alpha_opt = c(xa_dead= 0.02, urea = 70, VSd = 0.02),
alpha_T_min = c(xa_dead= 0, urea = 0, VSd = 0),
alpha_T_opt = c(xa_dead= 50, urea = 50, VSd = 50),
alpha_T_max = c(xa_dead= 60, urea = 60, VSd = 60))
chem_pars = list(COD_conv = c(CH4 = 0.2507, xa_dead = 0.73,
VFA = 0.93, S = 0.5015, VS = 0.69, CO2_anaer = 0.53, CO2_aer = 1.1, CO2_sr = 1.2, CO2_ureo = 1.57,
C_xa_dead = 0.358, C_VFA = 0.374, C_VSd = 0.344, C_N_urea = 0.429),
kl = c(NH3 = 52, NH3_floor = 22, H2S = 0.02))
vars <- c(0.2, 0.3, 0.5, 0.7, 0.9, 1, 1.25, 1.5, 2, 3, 4, 5)
l <- length(vars)
pars_test <- data.frame(alpha_opt = c(vars, vars, rep(1, l)),
qhat_opt = c(vars, rep(1, l), vars))
pred_C_all <- NULL
pred_FF_all <- NULL
pred_SF_all <- NULL
pred_ST_all <- NULL
dat <- read.csv('../data/pred_barn.csv')
pred_all <- NULL
o = 'C'
dat_sim <- dat[dat$treat == o,]
end_rows <- c(which(diff(dat_sim$time) < 0), nrow(dat_sim))
start_rows <- end_rows - end_rows[1] + 1
time_rows <- data.frame(rbind(start_rows, end_rows))
pred_treat <- NULL
time_rows
pars_test
i = 6
# slurry mass handled and prepared for input
days <- 365 * 3
storage_dat <- dat_sim[time_rows[1,i]: time_rows[2,i],]
rem.rows <- which(diff(storage_dat$slurry_mass_eff) < 0)
times <- c(storage_dat$time[rem.rows], storage_dat$time[rem.rows] + (max(storage_dat$time[rem.rows]) + 6),
storage_dat$time[rem.rows] + 2 * (max(storage_dat$time[rem.rows])+6),
storage_dat$time[rem.rows] + 3 * (max(storage_dat$time[rem.rows])+6),
storage_dat$time[rem.rows] + 4 * (max(storage_dat$time[rem.rows])+6))
mass <- c(rep(storage_dat$slurry_mass_eff[rem.rows], 5))
slurry_mass_dat <- data.frame(time = times, slurry_mass = cumsum(mass))
slurry_mass_dat <- setNames(data.frame(approx(slurry_mass_dat$time, slurry_mass_dat$slurry_mass, xout = 1:days, method = 'constant')), c('time', 'slurry_mass'))
slurry_mass_dat <- slurry_app(days = days, begin = 'June', specs = data.frame(app1s = 0.1, app2s = 1, app_t1s = 'September', app_t2s = 'March'), from = 'storage', slurry = slurry_mass_dat)
slurry_mass_dat$slurry_mass[is.na(slurry_mass_dat$slurry_mass)] <- 0
# get concentrations of microbial populations in the slurry excreted to the storage
xa_fresh <- colMeans(storage_dat[rem.rows,grepl("m[0-9]_eff_conc|sr[0-9]_eff_conc", names(storage_dat))])
names(xa_fresh) <- textclean::mgsub(names(xa_fresh), c("xa_", "_eff_conc"), c("", ""))
# get concentrations of substrates in the slurry excreted to the storage
conc_fresh <- list(S2 = mean(storage_dat[rem.rows, "sulfide_eff_conc"]), urea = mean(storage_dat[rem.rows, "urea_eff_conc"]),
SO4 = mean(storage_dat[rem.rows, "sulfate_eff_conc"]), TAN = mean(storage_dat[rem.rows, "TAN_eff_conc"]),
VFA = mean(storage_dat[rem.rows, "VFA_eff_conc"]),
xa_dead = mean(storage_dat[rem.rows, "xa_dead_eff_conc"]),
VSd = mean(storage_dat[rem.rows, "VSd_eff_conc"]),
VSd_A = mean(storage_dat[rem.rows, 'VSd_A_eff_conc']))
mng_pars = list(slurry_prod_rate = 0,
slurry_mass = slurry_mass_dat,
storage_depth = 4,
resid_depth = 0.035,
floor_area = 0,
area = 20,
empty_int = 35,
temp_C = dat_temp,
wash_water = 0,
wash_int = NA,
rest_d = 7,
RH = 90,
cover = 'tent',
resid_enrich = 0,
slopes = c(urea = NA, slurry_prod_rate = NA),
scale = c(ks_coefficient = opt_pars$scale.ks_coefficient,
qhat_opt = pars_test[i, 'qhat_opt'] * opt_pars$scale.qhat_opt,
xa_fresh = opt_pars$scale.xa_fresh, yield = 1,
alpha_opt = pars_test[i, 'alpha_opt'] * opt_pars$scale.alpha_opt))
grp_pars = list(grps = c('m0','m1','m2', 'sr1'),
yield = c(default = 0.05, sr1 = 0.065),
xa_fresh = xa_fresh,
xa_init = c(all = 0.0001),
decay_rate = c(all = 0.02),
ks_coefficient = c(default = 1, sr1 = 0.4),
qhat_opt = c(m0 = 1.5, m1 = 3.6, m2 = 5.6 , m3 = 7.2, m4 = 8, m5 = 8, sr1 = 8),
T_opt = c(m0 = 18, m1 = 18, m2 = 28, m3 = 36, m4 = 43.75, m5 = 55, sr1 = 43.75),
T_min = c(m0 = 0, m1 = 10, m2 = 10, m3 = 15, m4 = 26.25, m5 = 30, sr1 = 0),
T_max = c(m0 = 25, m1 = 25, m2 = 38, m3 = 45, m4 = 51.25, m5 = 60, sr1 = 51.25),
ki_NH3_min = c(all = 0.015),
ki_NH3_max = c(all = 0.13),
ki_NH4_min = c(all = 2.7),
ki_NH4_max = c(all = 4.8),
pH_upr = c(all = 8.0),
pH_lwr = c(default = 6.0))
wthr_pars = list(temp_air_C = 20, RH = 90, rain = 0, pres_kpa = 101, rs = 10) # no rain due to cover
evap_pars = list(evap = 0 * et(temp_C = wthr_pars$temp_air_C, pres_kpa = wthr_pars$pres_kpa, rs = wthr_pars$rs)) # no evap due to cover
pred <- cbind(abm(days = days, times = sort(c(times[times <= days], 1:days)), wthr_pars = wthr_pars, evap_pars = evap_pars,
mng_pars = mng_pars, grp_pars = grp_pars, add_pars = list(conc_fresh = conc_fresh)), treat = o, i)
plot(pred$time, pred$CH4_emis_rate)
pred$CH4_emis_rate[pred$time < 104]
CH4_rate2 <- pred$CH4_emis_rate[pred$time < 104]
plot(pred$time[pred$time < 104],pred$CH4_emis_rate[pred$time < 104])
plot(pred$time[pred$time < 104],pred$slurry_mass[pred$time < 104])
plot(pred$time[pred$time < 104],pred$slurry_mass[pred$time < 104]/1000)
